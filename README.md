# MCP自然言語クライアント

OpenAI APIを使用して、自然言語でMCPサーバーとやり取りするクライアントプログラムです。

## 機能

- 自然言語でユーザーの要求を受け取る
- OpenAI GPT-4がMCPサーバーのツールを適切に選択・実行
- ツール実行結果をAIが解釈してユーザーに返答
- 対話形式のCLIインターフェース
- 会話履歴の保持とリセット機能

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

`.env.example`をコピーして`.env`ファイルを作成し、OpenAI APIキーを設定してください。

```bash
cp .env.example .env
# .envファイルを編集してAPIキーを設定
```

または、環境変数を直接エクスポート:

```bash
export OPENAI_API_KEY=your-api-key-here
```

## 使い方

### 基本的な使い方

```bash
npm start
```

または

```bash
node src/index.js
```

### 対話例

プログラムは詳細なデバッグログを出力し、処理の流れが分かりやすくなっています:

```
あなた: 東京の現在時刻を教えて

======================================================================
【ステップ1】ユーザーメッセージを受信
======================================================================
入力: "東京の現在時刻を教えて"

======================================================================
【ステップ2】OpenAI APIに問い合わせ中...
======================================================================
モデル: gpt-4o
利用可能なツール数: 2

======================================================================
【ステップ3】OpenAIからの応答を受信
======================================================================
Finish reason: tool_calls

======================================================================
【ステップ4-1】MCPツールの実行
======================================================================
実行するツール数: 1

  → ツール名: get_current_time
  → 引数: {
       "timezone": "Asia/Tokyo"
     }
  → MCPサーバーに送信中...
  ✓ 実行成功
  → 結果: 現在時刻 (Asia/Tokyo): 2024/12/24 14:30:45

======================================================================
【ステップ5】ツール結果をOpenAIに送信中...
======================================================================
Finish reason: stop

======================================================================
【ステップ6】最終応答の生成完了
======================================================================
応答の長さ: 45文字

======================================================================
【最終結果】AIからの返答
======================================================================
東京の現在時刻は2024年12月24日 14時30分45秒です。
======================================================================
```

### 処理フロー

各ユーザー入力に対して、以下のステップで処理されます:

1. **ステップ1**: ユーザーメッセージを受信
2. **ステップ2**: OpenAI APIに問い合わせ（自然言語理解）
   - 送信するメッセージの全文を表示
   - 送信するツール定義の全文を表示
3. **ステップ3**: OpenAIからの応答を受信
   - 受信した応答の全文（JSON形式）を表示
4. **ステップ4**: 必要に応じてMCPツールを実行（複数回の可能性あり）
5. **ステップ5**: ツール結果をOpenAIに送信して解釈
   - 会話履歴（最新5件）を表示
   - 受信した応答の全文を表示
6. **ステップ6**: 最終応答を生成
   - 最終応答の内容を表示
7. **最終結果**: ユーザーに返答を表示

すべてのステップが視覚的に区切られており、OpenAI APIとのやり取りの詳細（送信内容・受信内容）がJSON形式で確認できます。

### コマンド

- `quit` または `exit`: プログラムを終了
- `reset`: 会話履歴をリセット

## アーキテクチャ

### コンポーネント

1. **MCPClient** ([src/mcp-client.js](src/mcp-client.js))
   - MCPサーバーとの接続を管理
   - ツールのリスト取得
   - ツールの実行

2. **OpenAIClient** ([src/openai-client.js](src/openai-client.js))
   - OpenAI APIとの通信
   - MCPツールをOpenAI形式に変換
   - Function Calling (ツール使用)ループの処理
   - 会話履歴の管理

3. **Main CLI** ([src/index.js](src/index.js))
   - ユーザーインターフェース
   - 対話ループの管理
   - MCPClientとOpenAIClientの統合

### 処理フロー

```
ユーザー入力
    ↓
OpenAIClient (自然言語理解)
    ↓
ツール選択・パラメータ抽出 (Function Calling)
    ↓
MCPClient (ツール実行)
    ↓
結果をOpenAIに返す
    ↓
AIが結果を解釈
    ↓
自然言語でユーザーに返答
```

## 技術スタック

- **Node.js**: JavaScript実行環境
- **openai**: OpenAI API クライアント (GPT-4o)
- **@modelcontextprotocol/sdk**: MCP SDK
- **ES Modules**: モダンなJavaScriptモジュールシステム

## 対応するMCPサーバー

このクライアントは、以下のMCPサーバーと接続しています:

- **@odenalexbs/mcp-sample-server**
  - `get_current_time`: 現在時刻の取得
  - `calculate`: 四則演算の実行
  - その他のツール

### MCPサーバーの接続設定

MCPサーバーへの接続は、環境変数またはコード内で設定できます。

#### デフォルト設定

デフォルトでは、npmに公開されている `@odenalexbs/mcp-sample-server` パッケージをnpx経由で実行します:

```bash
npx -y @odenalexbs/mcp-sample-server
```

この方法では、毎回最新バージョンがダウンロードされて実行されます。

#### 環境変数での設定（カスタマイズする場合）

`.env`ファイルに以下を追加:

```bash
# デフォルト（npx経由）
MCP_SERVER_COMMAND=npx
MCP_SERVER_ARGS=-y @odenalexbs/mcp-sample-server

# または、独自のローカルサーバーを使用する場合
# MCP_SERVER_COMMAND=node
# MCP_SERVER_ARGS=/path/to/your-mcp-server/dist/index.js
```

#### コード内での設定

[src/index.js](src/index.js#L25-L41) で直接編集することもできます:

**オプション1: npx経由で実行** (デフォルト)
```javascript
const serverCommand = "npx";
const serverArgs = ["-y", "@odenalexbs/mcp-sample-server"];
```

**オプション2: ローカルインストールされたnpmパッケージを使用**
```javascript
const serverCommand = "node";
const serverArgs = ["node_modules/@odenalexbs/mcp-sample-server/dist/index.js"];
```

**オプション3: ローカルにビルドされた独自サーバーを使用**
```javascript
const serverCommand = "node";
const serverArgs = ["/path/to/your-mcp-server/dist/index.js"];
```

## ライセンス

ISC
